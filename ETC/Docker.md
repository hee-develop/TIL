2021-04-03
---

# Docker 개념과 사용 방법

## Docker
- Docker는 컨테이너 기반의 오픈소스 가상화 플랫폼.
- 컨테이너는 기존의 가상화(OS가상화나 CPU가상화)에서 발생하는 성능 이슈를 해결하기 위해 만들어진 새로운 형태의 가상화.
  메모리나 CPU같은 자원은 공유하되, 프로세스만 격리시켜 가상화하기 때문에, 기존 가상화에 비해 성능이슈가 덜 하다는 장점이 있음.

## Docker image
- 이미지(docker image)란, 컨테이너를 구동하기 위해 필요한 파일이나 설정 등의 정보가 포함되어 있는 파일. ISO를 생각하면 이해가 쉬울 듯
- 서버 구축을 할 때, 환경변수를 설정하거나, 같은 버전의 라이브러리를 설치하거나 하는 복잡한 작업을 '이미지'라는 파일 안에 집어넣음으로써 불필요한 시간 소비를 줄임.

## Docker image
- 도커는 `레이어`라는 개념을 사용해 이미지를 효율적으로 관리할 수 있게끔 해 줌.
- 예를 들어, `A`라는 이미지와 `B`라는 이미지는 둘 다 `Ubuntu`를 기반으로 만들어진 이미지라고 하면,
  - 어떠한 시스템에서 `A`와 `B`를 사용하려면 `Ubuntu`를 두 번 받아야만 함(`A`와 `B`모두 `UbuntuOS`를 필요로 하기 때문에)
  - 그러나 `레이어`를 사용해 `Ubuntu`레이어를 나누어 두면, `A`를 받을 때 `Ubuntu`를 미리 받아 두었기 때문에 `B`를 받을 땐 `Ubuntu`를 받을 필요가 없음(받을 때 시간적, 공간적으로 절약이 가능).
- 이미지는 `tag`로 편하게 버전을 관리할 수 있음.

## Dockerfile
- `Dockerfile`이란, 이미지를 만들기 위한 일련의 과정을 담은 파일
- 어떤 이미지를 베이스로, 무슨 파일을 복사하고, 패키지를 설치하고.. 등등의 과정이 담겨 있음

## 어디에 쓰는지?
- 규모가 큰 서버 : 다수의 프로세스로 같은 서버를 구동시켜야 할 때 유용하게 사용할 수 있음
  - 특히 수요에 의해 갑작스레 서버를 증설해야 할 필요가 있을 때, 도커라면 같은 이미지로 구동만 시키면 끝이지만, 일반적인 경우 환경변수부터 하나씩 차근차근 설정해 나가야 한다(이 경우 Ansible같은 도구를 사용함).
- 개발 환경 : 각자 다른 OS를 사용해 개발한다던가, 이런저런 이유로 로컬에서 개발이 어려운 경우 유용하게 사용 가능
  - 첫 회사에서 프로덕트 개발을 위해 개발 환경을 구성했는데, 하필 OS 버전이 나만 달라서 환경 구성이 3일(...)이나 걸렸던 경험이 있다

## Docker 명령어

### `docker run`
- `-d`: 백그라운드 모드
- `-p`: 포트 포워딩
- `-v`: 볼륨 마운트
- `-e`: 환경 변수 설정
- `-name`: 컨테이너 이름
- `-rm`: 프로세스 종료 시 컨테이너 자동 제거

```shell
% docker run -d -p 8080:80 \
    -e DATABASE_NAME=db \
    -it \
    -rm
    dockerimg .
```
`dockerimg` 이미지를 기반으로 컨테이너를 실행하되,
포트는 8080포트를 컨테이너의 내부 80포트에 연결하고,
환경 변수로 `DATABASE_NAME`을 `db`로 설정하고,
표준 입력을 받도록 하며,
프로세스가 종료되면 컨테이너를 제거한다.

### `docker ps`
- 옵션 없음 : 실행중인 컨테이너의 목록을 표시
- `-a`: 종료된 컨테이너도 표시
- `-q`: 컨테이너의 ID만 표시

### `docker log`
`STDOUT`, `STDERR`만을 수집함. 로그는 json파일로 저장되므로, 규모가 큰 서비스는 로그 서비스를 이용하지 않으면 파일이 계속 커지므로 주의.
- `--tail`: 마지막 ~줄만 출력
- `-f`: 실시간 출력

### `docker exec`
컨테이너에 접속하기 위한 명령어. run과 비슷하나 현재 실행중인 컨테이너에 명령을 실행시킨다는 차이점이 있음

## 볼륨
- 컨테이너는 하나의 환경이므로, 컨테이너를 삭제(이미지 업데이트 등을 이유로 삭제하는 경우가 있음)하면 내부에 저장되어 있던 파일도 함께 삭제되어버림
- 때문에 볼륨을 설정해 영구 저장이 필요한 데이터는 컨테이너 외부로 저장할
- `-v [외부저장소]:[컨테이너내부]` 으로 마운트 가능.

## Docker compose
여러 컨테이너를 종합적으로 다뤄야 할 때 사용. 예를 들어, 웹 서버를 하나 만든다고 가정하면,
DB를 다룰 DB컨테이너와 웹 서버 컨테이너 두 개를 다뤄야 한다. 각각 켜고 끄는 것은 귀찮은 일이므로, `docker compose`를 이용해 간편히 켜고 끄는 등의 행위를 할 수 있게 된다.

